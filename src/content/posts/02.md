---
title: "搭建 npm 私服"
date: "2025-11-28"
category: "npm"
tags: ["Web"]
description: "CNPM搭建私有的NPM服务"
image: ""
---

## node.js 安装

执行以下命令安装 Node.js：

```bash
# 进入安装目录
cd /usr/local/src

# 下载 Node.js 安装包
sudo wget https://nodejs.org/dist/v20.10.0/node-v20.10.0-linux-x64.tar.xz

# 解压安装包
tar -xvf node-v20.10.0-linux-x64.tar.xz

# 创建软链接
sudo ln -s /usr/local/src/node-v20.10.0-linux-x64/bin/node /usr/bin/node
sudo ln -s /usr/local/src/node-v20.10.0-linux-x64/bin/npm /usr/bin/npm
```

验证安装结果：

```bash
node v20.10.0
npm 10.2.3
```

## 拉取 cnpmjs 仓库

```bash
# 克隆 cnpmjs 仓库
git clone https://github.com/cnpm/cnpmjs.org.git

# 进入项目目录
cd cnpmjs.org

# 安装依赖
sudo npm install
```

## 安装 mysql-server

```bash
sudo apt install mysql-server
```

安装成功后，MySQL 服务会自动启动，可通过以下命令验证：

```bash
sudo systemctl status mysql
```

## 初始化数据库

在 cnpmjs.org 目录下执行以下命令初始化数据库：

```bash
mysql -uroot -p<password> -e 'DROP DATABASE IF EXISTS cnpmjs_test;' && \
mysql -uroot -p<password> -e 'CREATE DATABASE cnpmjs_test;' && \
mysql -uroot -p<password> 'cnpmjs_test' < docs/db.sql && \
mysql -uroot -p<password> 'cnpmjs_test' -e 'show tables;'
```

执行成功后会显示以下表结构：

```
+-----------------------+
| Tables_in_cnpmjs_test |
+-----------------------+
| dist_dir              |
| dist_file             |
| download_total        |
| module                |
| module_deps           |
| module_keyword        |
| module_log            |
| module_maintainer     |
| module_star           |
| module_unpublished    |
| tag                   |
| total                 |
| user                  |
+-----------------------+
```

## 修改数据库配置

编辑配置文件：

```bash
vi ./config/index.js
```

修改以下数据库配置项：

```javascript
db: 'cnpmjs_test',
username: 'root',
password: 'xxxxxx',
dialect: 'mysql',
```

## 启动服务

```bash
sudo node dispatch.js
```

> **注意**：若需对外网开放访问，需注释掉配置文件中的 `bindingHost` 一行。

## 常见问题

### MySQL 认证模式错误

**错误信息**：`ER_NOT_SUPPORTED_AUTH_MODE: Client does not support authentication protocol requested by server`

**解决命令**：
```sql
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '你的密码';
```
